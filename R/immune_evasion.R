#' .. content for \description{} (no empty lines) ..
#'
#' .. content for \details{} ..
#'
#' @title
#' @param neut_model
#' @return
#' @author Nick Golding
#' @export
# get the degree of immune evasion (among the vaccinated) from the neut model
immune_evasion <- function(
  neut_model,
  baseline_immunity = c(
    "za",
    "AZ_dose_2",
    "Pfizer_dose_2",
    "AZ_dose_1",
    "Pfizer_dose_1",
    "mRNA_booster"
  ),
  days_waning = 0
) {

  baseline_immunity <- match.arg(baseline_immunity)

  # either the South African immunity, immunity from WT infection, or vaccine derived immunity
  if (baseline_immunity == "za") {
    # find the inferred level of immunity in ZA
    peak_baseline_immunity_log10_neut_fold <- neut_model$model_objects$za_baseline_immunity_log10_neut_fold
  } else if (baseline_immunity == "infection"){
    # set to 0 for WT immunity
    peak_baseline_immunity_log10_neut_fold <- neut_model$model_objects$za_baseline_immunity_log10_neut_fold * 0
  } else {
    # find the corresponding vaccine-derived immunity
    idx <- match(baseline_immunity, neut_model$lookups$immunity)
    peak_baseline_immunity_log10_neut_fold <- neut_model$model_objects$peak_mean_log10_neuts[idx]
  }

  baseline_immunity_log10_neut_fold <- log10_neut_over_time_varying_analytic(
    time = days_waning,
    maximum_log10_neut = peak_baseline_immunity_log10_neut_fold,
    max_decay = neut_model$model_objects$neut_decay,
    min_decay = neut_model$model_objects$min_neut_decay,
    end_decline = neut_model$model_objects$decay_end_decline,
    start_decline = neut_model$model_objects$decay_start_decline
  )

  # fold change for omicron
  omicron_log10_neut_fold <- neut_model$model_objects$omicron_log10_neut_fold

  omicron_ves_peak <- ve_from_mean_log10_neut(
    mean_log10_neut_vec = rep(baseline_immunity_log10_neut_fold + omicron_log10_neut_fold, 5),
    sd_log10_neut = neut_model$model_objects$sd_log10_neut_titres,
    log_k = neut_model$model_objects$log_k,
    c50_vec = neut_model$model_objects$c50s,
    method =  "gaussian"
  )

  delta_ves_peak <- ve_from_mean_log10_neut(
    mean_log10_neut_vec = rep(baseline_immunity_log10_neut_fold, 5),
    sd_log10_neut = neut_model$model_objects$sd_log10_neut_titres,
    log_k = neut_model$model_objects$log_k,
    c50_vec = neut_model$model_objects$c50s,
    method =  "gaussian"
  )

  acquisition_idx <- match("acquisition", neut_model$lookups$outcome)
  transmission_idx <- match("transmission", neut_model$lookups$outcome)

  omicron_vaccine_reduction <- prod(1 - omicron_ves_peak[c(acquisition_idx, transmission_idx)])
  delta_vaccine_reduction <- prod(1 - delta_ves_peak[c(acquisition_idx, transmission_idx)])

  # VEs against overall transmission for omicron and delta
  omicron_overall_ve <- 1 - omicron_vaccine_reduction
  delta_overall_ve <- 1 - delta_vaccine_reduction

  # % reduction in overall VE against transmission
  1 - omicron_overall_ve / delta_overall_ve

}

